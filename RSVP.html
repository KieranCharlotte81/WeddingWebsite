<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>RSVP</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Allura&family=Open+Sans&display=swap" rel="stylesheet">

    <style>
      body {
        font-family: 'Open Sans', sans-serif;
        background-image: url('your-background.jpg'); /* Replace with your image path */
        background-size: cover;
        background-repeat: repeat;
        background-attachment: fixed;
        color: #333;
        margin: 0;
        padding: 0;
      }

      .container {
        max-width: 600px;
        margin: 50px auto;
        padding: 30px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      h2 {
        text-align: center;
        font-family: 'Allura', cursive;
        font-size: 48px;
        margin-bottom: 20px;
      }

      .form-section {
        margin-top: 20px;
      }

      input[type="text"],
      input[type="submit"],
      .dietary {
        width: 100%;
        padding: 10px;
        margin-top: 8px;
        margin-bottom: 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
      }

      .radio-group {
        display: flex;
        gap: 15px;
        margin-top: 10px;
      }

      .radio-group label {
        flex: 1;
      }

      .guest-header {
        font-weight: bold;
        margin-top: 15px;
      }

      #submit-button {
        background-color: #444;
        color: white;
        border: none;
        cursor: pointer;
        transition: 0.3s;
      }

      #submit-button:hover {
        background-color: #222;
      }

      .error {
        color: red;
        margin-top: 10px;
      }

      .loading {
        font-style: italic;
        margin-top: 10px;
        color: #666;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2>Wedding RSVP</h2>

      <!-- Passcode Section -->
      <div id="passcode-section" class="form-section">
        <label for="passcode">Enter your passcode:</label>
        <input type="text" id="passcode" placeholder="e.g. 1234" />
        <input type="submit" onclick="checkPasscode()" value="Submit" />
        <div id="loading-message-passcode" class="loading"></div>
        <div id="passcode-error" class="error"></div>
      </div>

      <!-- RSVP Form Section (Initially Hidden) -->
      <div id="rsvp-form" class="form-section" style="display: none;">
        <div id="arrival-message"></div>
        <form onsubmit="submitRSVP(event)">
          <div id="guest-forms"></div>
          <input id="submit-button" type="submit" value="Submit RSVP" />
          <div id="loading-message-rsvp" class="loading"></div>
        </form>
      </div>
    </div>

    <script>
      window.onload = function () {
        const SCRIPT_URL = "YOUR_SCRIPT_URL_HERE"; // Replace with your script URL

        let currentPasscode = "";
        let guests = [];

        window.checkPasscode = function () {
          const passcode = document.getElementById('passcode').value.trim();
          document.getElementById('passcode-error').textContent = "";
          document.getElementById('loading-message-passcode').textContent = "";

          if (!passcode) {
            document.getElementById('passcode-error').textContent = "Please enter a passcode.";
            return;
          }

          document.getElementById('loading-message-passcode').textContent = "Please wait...";

          fetch(`${SCRIPT_URL}?action=validatePasscode&passcode=${encodeURIComponent(passcode)}`)
            .then(res => res.json())
            .then(handlePasscode)
            .catch(err => {
              console.error(err);
              document.getElementById('loading-message-passcode').textContent = "";
              document.getElementById('passcode-error').textContent = "There was an error. Please try again.";
            });
        }

        function handlePasscode(data) {
          document.getElementById('loading-message-passcode').textContent = "";

          if (!data.valid) {
            document.getElementById('passcode-error').textContent = data.message || "Invalid passcode.";
            return;
          }

          currentPasscode = document.getElementById('passcode').value.trim();
          guests = data.guests || [];

          document.getElementById('passcode-section').style.display = 'none';
          document.getElementById('rsvp-form').style.display = 'block';

          const guestForms = document.getElementById('guest-forms');
          guestForms.innerHTML = "";

          guests.forEach((guest, idx) => {
            const formBlock = document.createElement('div');
            formBlock.className = 'guest-form';

            formBlock.innerHTML = `
              <div class="guest-header">${guest}</div>
              <div class="radio-group">
                <label><input type="radio" name="rsvp-${idx}" value="Accepts" required> Accepts</label>
                <label><input type="radio" name="rsvp-${idx}" value="Declines"> Declines</label>
              </div>
              <input class="dietary" name="diet-${idx}" type="text" placeholder="Dietary requirements">
            `;

            guestForms.appendChild(formBlock);
          });

          document.getElementById('arrival-message').textContent = `Welcome, ${guests.join(" & ")} (${data.guestType})`;
        }

        window.submitRSVP = function (e) {
          e.preventDefault();

          const submitBtn = document.getElementById('submit-button');
          submitBtn.disabled = true;
          document.getElementById('loading-message-rsvp').textContent = "Please wait...";

          const responses = guests.map((guest, idx) => {
            const rsvp = document.querySelector(`[name="rsvp-${idx}"]:checked`);
            const diet = document.querySelector(`[name="diet-${idx}"]`).value.trim();
            return {
              name: guest,
              rsvp: rsvp ? rsvp.value : '',
              diet: diet
            };
          });

          const payload = {
            passcode: currentPasscode,
            responses: responses
          };

          const formData = new URLSearchParams();
          formData.append('action', 'submitRSVP');
          formData.append('data', JSON.stringify(payload));

          fetch(SCRIPT_URL + "?action=submitRSVP", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formData
          })
            .then(res => res.json())
            .then(result => {
              submitBtn.disabled = false;
              document.getElementById('loading-message-rsvp').textContent = "";

              if (result.success) {
                document.body.innerHTML = `
                  <div class="container">
                    <h2>Thank You! ðŸŽ‰</h2>
                    <p>Your RSVP has been recorded. We canâ€™t wait to celebrate with you!</p>
                    <p><a href="https://www.google.com">Click here for more information</a></p>
                  </div>`;
              } else {
                alert("Error: " + result.message);
              }
            })
            .catch(err => {
              submitBtn.disabled = false;
              document.getElementById('loading-message-rsvp').textContent = "";
              console.error(err);
              alert("There was an error submitting your RSVP. Please try again.");
            });
        }
      };
    </script>
  </body>
</html>
